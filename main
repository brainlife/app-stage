#!/bin/env python

#PBS -l nodes=1:ppn=1
#PBS -l vmem=1gb
#PBS -l walltime=00:05:00
#PBS -N stage
#PBS -q normal
#PBS -A TG-DBS170009

import json
import subprocess
import errno
import os
import sys
import json

def makedirp(dir):
    try: 
	os.makedirs(dir)
    except OSError as exc:
	if exc.errno == errno.EEXIST and os.path.isdir(dir):
	    pass
	else:
	    raise

with open("config.json") as config_json:
    config = json.load(config_json)
    for dataset in config["datasets"]:

        print("staging %s" % dataset["id"])

        storage = "wrangler"
        if "storage" in dataset:
            storage = dataset["storage"]

        outdir=dataset["id"]
        if 'outdir' in dataset:
            outdir=dataset["outdir"]

        if storage == "wrangler":
	    makedirp(outdir)
            src=os.environ["BRAINLIFE_ARCHIVE"]+"/"+dataset["project"]+"/"+dataset["id"]+".tar"
            code=subprocess.call(["tar", "xf", src, "-C", outdir])
            if code != 0:
                sys.exit(code)
	elif storage == "url":
	    makedirp(outdir)
            for file in dataset["storage_config"]["files"]:
                code=subprocess.call(["wget", "-O", outdir+"/"+file["local"], file["url"]])
                if code != 0:
                    sys.exit(code)
        else:
            #download from brainlife download server
            #print(["bl", "dataset", "download", dataset["id"], outdir])
            code=subprocess.call(["bl", "dataset", "download", dataset["id"], outdir])
            if code != 0:
                sys.exit(code)
            
        #check to see .brainlife.json exists (old dataset doesn't have it)
        if not os.path.isfile(outdir+"/.brainlife.json"):
            print "no .brainlife.json.. creating substitute"
            #find the _outputs
            if "_outputs" in config:
                for output in config["_outputs"]:
                    if "dataset_id" in output and "meta" in output and output["dataset_id"] == dataset["id"]:
                        #print("using config._outputs")
                        #print(output)
                        with open(outdir+"/.brainlife.json", "w") as f:
                            json.dump(output, f)


